#
# Pre-deployment tasks
#
- id: midonet_install_dependencies
  role: [primary-controller, controller, compute, nsdb]
  stage: pre_deployment/6001
  required_for: [pre_deployment_end]
  type: shell
  parameters:
    cmd: ./install_dependencies.sh
    timeout: 360

# Post-deployment tasks
- id: midonet_enable_ip_forward
  role: [nsdb, compute]
  stage: post_deployment/4400
  required_for: [post_deployment_end]
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/midonet-enable-ip-forward.pp
    puppet_modules: "puppet/modules/:/etc/puppet/modules/"
    timeout: 360
- id: midonet_cassandra_and_zookeeper
  role: [nsdb]
  stage: post_deployment/6001
  required_for: [deploy_end]
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/midonet-nsdb.pp
    puppet_modules: "puppet/modules/:/etc/puppet/modules/"
    timeout: 360
- id: midonet_clean_neutron_db
  role: [primary-controller]
  stage: post_deployment/6400
  type: shell
  parameters:
    cmd: ./clean_neutron.sh
    timeout: 360
  fail_on_error: false
- id: midonet_disable_services
  role: [primary-controller, controller, compute]
  stage: post_deployment/6405
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/midonet-disable-services.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 60
- id: midonet_deploy_api
  role: [primary-controller, controller]
  stage: post_deployment/6410
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/midonet-install-api.pp
    puppet_modules: puppet/modules:/etc/puppet/modules/
    timeout: 360
- id: midonet_agent
  role: [primary-controller, controller, compute]
  stage: post_deployment/6415
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/midonet-install-agent.pp
    puppet_modules: "puppet/modules/:/etc/puppet/modules/"
    timeout: 360
- id: midonet_delete_datapaths
  role: [primary-controller, controller, compute]
  stage: post_deployment/6420
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/midonet-delete-datapaths.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 60
- id: midonet_host_registry
  role: [primary-controller, controller, compute]
  stage: post_deployment/6425
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/midonet-host-registry.pp
    puppet_modules: "puppet/modules/:/etc/puppet/modules/"
    timeout: 360
- id: midonet_reconfigure_neutron
  role: [primary-controller, controller]
  stage: post_deployment/6430
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/midonet-reconfigure-neutron.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 220
- id: midonet_recreate_neutron_db
  role: [primary-controller]
  stage: post_deployment/6435
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/midonet-recreate-neutron-db.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 360
- id: midonet_restart_neutron
  role: ['primary-controller', 'controller']
  stage: post_deployment/6440
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/midonet-restart-neutron.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 210
